---
title: "Portfolio"
author: "Sidney Francis"
date: "14/02/2021"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    theme: default

---

```{r, libaries}
library(spotifyr)
library(ggplot2)
library(plotly)
library(tidyverse)
library(usethis)
library(remotes)
library(flexdashboard)
library(compmus)
library(cowplot)
library(gridExtra)
library(tidymodels)
library(kknn)
library(heatmaply)
library(ggdendro)
library(tibble)
```



```{r, circs, echo=FALSE}
circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )

key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )
```

```{r, sixties, echo=FALSE}
playlist_username <- 'spotify'
playlist_uris <- c('37i9dQZF1DXaKIA8E7WcJj')
sixties<- 
get_playlist_audio_features(playlist_username, playlist_uris)

playlist_username <- 'spotify'
playlist_uris <- c('37i9dQZF1DWTJ7xPn4vNaz')
seventies<- get_playlist_audio_features(playlist_username, playlist_uris)

playlist_username <- 'spotify'
playlist_uris <- c('37i9dQZF1DX4UtSsGT1Sbe')
eighties<-  get_playlist_audio_features(playlist_username, playlist_uris)

playlist_username <- 'spotify'
playlist_uris <- c('37i9dQZF1DXbTxeAdrVG2l')
nineties<- get_playlist_audio_features(playlist_username, playlist_uris)

playlist_username <- 'spotify'
playlist_uris <- c('37i9dQZF1DX4o1oenSJRJd')
thousands<- get_playlist_audio_features(playlist_username, playlist_uris)

playlist_username <- 'spotify'
playlist_uris <- c('37i9dQZF1DX5Ejj0EkURtP')
tens<- get_playlist_audio_features(playlist_username, playlist_uris)
```


```{r, top20, echo= FALSE}
top20 <-
  sixties %>% top_n(20, danceability) %>%
  mutate(country = "The 60s") %>%
  bind_rows(seventies %>% top_n(20, danceability) %>% mutate(country = "The 70s")) %>%
  bind_rows(eighties %>% top_n(20, danceability) %>% mutate(country = "The 80s")) %>% 
  bind_rows(nineties %>% top_n(20, danceability) %>% mutate(country = "The 90s")) %>%
  bind_rows(thousands %>% top_n(20, danceability) %>% mutate(country = "The 00s")) %>%
  bind_rows(tens %>% top_n(20, danceability) %>% mutate(country = "The 10s")) %>%
  mutate(
    country = fct_relevel(country, "The 10s", "The 00s", "The 90s", "The 80s", "The 70s", "The 60s")
  )
```

```{r, TOP1, echo=FALSE}
top1 <-
  sixties %>% top_n(1, energy) %>%
  mutate(country = "The 60s") %>%
  bind_rows(seventies %>% top_n(1, energy) %>% mutate(country = "The 70s")) %>%
  bind_rows(eighties %>% top_n(1, energy) %>% mutate(country = "The 80s")) %>% 
  bind_rows(nineties %>% top_n(1, energy) %>% mutate(country = "The 90s")) %>%
  bind_rows(thousands %>% top_n(1, energy) %>% mutate(country = "The 00s")) %>%
  bind_rows(tens %>% top_n(1, energy) %>% mutate(country = "The 10s")) %>%
  mutate(
    country = fct_relevel(country, "The 10s", "The 00s", "The 90s", "The 80s", "The 70s", "The 60s")
  )
```

```{r, top150, echo=FALSE}
top150 <-
  sixties %>% top_n(150, tempo) %>%
  mutate(country = "The 60s") %>%
  bind_rows(seventies %>% top_n(150, tempo) %>% mutate(country = "The 70s")) %>%
  bind_rows(eighties %>% top_n(150, tempo) %>% mutate(country = "The 80s")) %>% 
  bind_rows(nineties %>% top_n(150, tempo) %>% mutate(country = "The 90s")) %>%
  bind_rows(thousands %>% top_n(150, tempo) %>% mutate(country = "The 00s")) %>%
  bind_rows(tens %>% top_n(150, tempo) %>% mutate(country = "The 10s")) %>%
  mutate(
    country = fct_relevel(country, "The 10s", "The 00s", "The 90s", "The 80s", "The 70s", "The 60s")
  )
```


### Plan
Arctic Monkeys is a band that blew up during the garage rock revival of the early 2000s. The band skyrocketed due to their debut album: Whatever People Say I am, That's What I'm Not (WPSIATWIN). Because of the fast paced music and Turner's cynical lyrics about nights out it resonated with a lot of young people. As they got older they progressed to a more sensitive look on music. Josh Homme, the main cog in Queens of the Stone Age, helped them with this. He produced their third album: Humbug; a more sensitive and thoughtful album. After this the band never went back to the aggressive boyish music they made before. I am very curious in what way this could be shown and proven with Spotify's API. By comparing different eras of the band I hope to give a clear view of their evolution. 

***
For some reason I'm unable to display more than one Key-, Chordo-, Chromagram without them overlapping.

### Computer Classification
```{r}
library(compmus)

get_conf_mat <- function(fit) {
  outcome <- .get_tune_outcome_names(fit)
  fit %>% 
    collect_predictions() %>% 
    conf_mat(truth = outcome, estimate = .pred_class)
}  

get_pr <- function(fit) {
  fit %>% 
    conf_mat_resampled() %>% 
    group_by(Prediction) %>% mutate(precision = Freq / sum(Freq)) %>% 
    group_by(Truth) %>% mutate(recall = Freq / sum(Freq)) %>% 
    ungroup() %>% filter(Prediction == Truth) %>% 
    select(class = Prediction, precision, recall)
}  

Humbug   <- 
  get_playlist_audio_features("Sidney Francis", "0z3uHF5QB4sJ8KcHQLDjKw")

Whatever <- get_playlist_audio_features("Sidney Francis", "20nBnqALo3mm3UehMXHvZq")

Tranquility <- get_playlist_audio_features("Sidney Francis", "1pMfrsZuzMuWBCGOKhdclb")

Favourite <- get_playlist_audio_features("Sidney Francis", "0lCqPpNJQ0jxXAP79aVQnY")
```

```{r}
AM <-
  bind_rows(
    Humbug %>% mutate(playlist = "Humbug") %>% slice_head(n = 20),
    Whatever %>% mutate(playlist = "WPSIATWIN") %>% slice_head(n = 20),
    Tranquility %>% mutate(playlist = "TBHC") %>% slice_head(n = 20)
  ) 

  AM_features <-
  AM %>%  # For your portfolio, change this to the name of your corpus.
  add_audio_analysis() %>% 
  mutate(
    playlist = factor(playlist),
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(
        segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean",
      )
  ) %>%
  mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
  mutate_at(vars(pitches, timbre), map, bind_rows) %>%
  unnest(cols = c(pitches, timbre))

AM_recipe <-
  recipe(
    playlist ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      duration +
      C + `C#|Db` + D + `D#|Eb` +
      E + `F` + `F#|Gb` + G +
      `G#|Ab` + A + `A#|Bb` + B +
      c01 + c02 + c03 + c04 + c05 + c06 +
      c07 + c08 + c09 + c10 + c11 + c12,
    data = AM_features,          # Use the same name as the previous block.
  ) %>%
  step_center(all_predictors()) %>%
  step_scale(all_predictors())      # Converts to z-scores.
  # step_range(all_predictors())    # Sets range to [0, 1].

indie_cv <- AM_features %>% vfold_cv(5)

knn_model <-
  nearest_neighbor(neighbors = 1) %>%
  set_mode("classification") %>% 
  set_engine("kknn")
indie_knn <- 
  workflow() %>% 
  add_recipe(AM_recipe) %>% 
  add_model(knn_model) %>% 
  fit_resamples(
    indie_cv, 
    control = control_resamples(save_pred = TRUE)
  )

indie_knn %>% get_conf_mat() %>% autoplot(type = "heatmap")
```

***
Even though the computer does not classify everything perfectly, it is clear that there is something in WPSIATWIN that is distinctly different than TBHC or Humbug. WPSIATWIN lies the furthest from Josh Homme's interference chronologically (and in my opinion musically). In the heatmap it is clear that Humbug and THBHC have more in common than WPSIATWIN.

### Quickest Albums
First we will be looking at the tempi of all songs for a couple of Albums before Josh Homme's interference. 
```{r, tempo_histogram, echo=FALSE}


Whatever_hista<- 
hist(Whatever$tempo, main = "Tempi in WPSIATWIN",
     xlab = "Tempo (BPM)",
     border="black", 
     col="blue", 
     xlim=c(50,250),
     ylim = c(0, 10),
     freq = TRUE)

Favourite_hista<-
  hist(Favourite$tempo, main = "Tempi in Favourite Worst Nightmare",  xlab = "Tempo (BPM)",
       border="black", 
     col="blue", 
     xlim=c(50,250),
     ylim = c(0, 5),
     freq = TRUE)

Humbug_hista<-
   hist(Humbug$tempo, main = "Tempi in the Humbug",
     xlab = "Tempo (BPM)",
       border="black", 
     col="blue", 
     xlim=c(50,250),
    ylim = c(0, 10),
     freq = TRUE)
     
Tranquility_hista<-
 hist(Tranquility$tempo, main = "Tempi TBHC",  xlab = "Tempo (BPM)",
      border="black", 
     col="blue", 
     xlim=c(50,250),
     ylim = c(0, 5),
     freq = TRUE)
```

***
Both Whatever People Say I am, That's What I'm Not (WPSIATWIN) and Favourite Worst Nightmare (FWN), are from before Josh Homme got involved in the band's sounds. Humbug was the first album produce by Josh Homme and after that the band leaned more into this type of music. This is clear from the aggressive vibes of the first couple of albums which very well represented in these histograms. There is a clear difference in tempi on the different albums.

### Tempi Popular Songs 
```{r, one_analysis}


shame70s <-
  get_tidy_audio_analysis("1l1YTy9nJ0trwhsCGcimly")

happy80s <-
  get_tidy_audio_analysis("5YbgcwHjQhdT1BYQ4rxWlD")


```

```{r, cache=TRUE, tempograms}

shame70s %>%
  tempogram(window_size = 8, hop_size = 1, cyclic = TRUE) %>%
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none") +
  labs(x = "Time (s)", y = "Tempo (BPM)") +
  theme_classic()


happy80s %>%
  tempogram(window_size = 8, hop_size = 1, cyclic = TRUE) %>%
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none") +
  labs(x = "Time (s)", y = "Tempo (BPM)") +
  theme_classic()


```

*** 
We'll be looking at two outliers in the form of tempograms.On the left a tempogram of an outlier (relatively high BPM in the seventies): It's a Shame  by the Spinners.On the right a tempogram of an outlier (relatively slow in the eighties): Don't Worry Be Happy by Bobby McFerry

### Histogram


```{r, histos, echo=FALSE}
sixties_hist<- 
hist(sixties$energy, main = "Energy in the 60s",
     xlab = "Energy Level",
     border="black", 
     col="purple", 
     xlim=c(0,1),
     ylim = c(0, 3),
     freq = FALSE)

seventies_hist<-
  hist(seventies$energy, main = "Energy in the 70s",  xlab = "Energy Level",
       border="black", 
     col="purple", 
     xlim=c(0,1),
    ylim = c(0, 3),
     freq = FALSE)

eighties_hist<-
   hist(eighties$energy, main = "Energy in the 80s",  
     xlab = "Energy Level",
       border="black", 
     col="purple", 
     xlim=c(0,1),
    ylim = c(0, 3),
     freq = FALSE)
     
nineties_hist<-
 hist(nineties$energy, main = "Energy in the 90s",  xlab = "Energy Level",
      border="black", 
     col="purple", 
     xlim=c(0,1),
    
     ylim = c(0, 3),
     freq = FALSE)

zeroes_hist<- 
   hist(thousands$energy, main = "Energy in the 00s",  xlab = "Energy Level",
        border="black", 
     col="purple", 
     xlim=c(0,1),
    
     ylim = c(0, 3),
     freq = FALSE)

tens_hist<-
   hist(tens$energy, main = "Energy in the 10s", xlab = "Energy Level",
        border="black", 
     col="purple", 
     xlim=c(0,1),
    
     ylim = c(0, 3),
     freq = FALSE,)


     

```


***
Here we have a clear view of the frequency of every energy level of every song in each playlist. This puts us one step closer to deciding which decade was the "Party Decade".




### Chordogram/Keygram

I'm still standing - Elton John

```{r, ISS, echo=FALSE}
ISS <-
  get_tidy_audio_analysis("0lzpfrTARexLFXEACKSXTh") %>% # Change URI.
  compmus_align(bars, segments) %>%                     # Change `bars`
  select(bars) %>%                                      #   in all three
  unnest(bars) %>%                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )

keygram <- ISS %>% 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) + ggtitle("Keygram: 'I'm Still Standing'") +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "Keys") 

chordogram <- ISS %>% 
  compmus_match_pitch_template(
    chord_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) + ggtitle("Chordogram: 'I'm Still Standing'") +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "Chords")
grid.arrange(keygram, chordogram)

```

***
These are the Keygram and Chordogram from one of the outliers. I haven't had the chance to compare these to other songs from my Corpus.



### Chroma/Cepstrograms



I'm Still Standing - Elton John
Self similarities




```{r, issgrams}
ISS %>%
  compmus_self_similarity(timbre, "aitchison") %>% 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "Time (s)", y = "Time (s)")

```

```{r, issmoregrams}
ISS %>%
  compmus_gather_timbre() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  scale_fill_viridis_c() +                              
  theme_classic()

```



### Graphs/Visuals









```{r, allplots}
  all_plots <-
  top20 %>%  
  ggplot(                          # Set up the plot.
    aes(
      x = energy,
      y = danceability,
      colour = mode,
      size = track.popularity,
      label = track.name           # Labels will be interactively visible.
    )
  ) +
  geom_point(shape = ".") +                   # Scatter plot.
  geom_rug(size = 0.1) +           # Add 'fringes' to show data distribution.
  facet_wrap(~country) +           # Separate charts per country.
  scale_x_continuous(              # Fine-tune the x axis.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),        # Use grid-lines for quadrants only.
    minor_breaks = NULL            # Remove 'minor' grid-lines.
  ) +
  scale_y_continuous(              # Fine-tune the y axis in the same way.
    limits = c(0.5, 1),
    breaks = c(0, 0.50, 1),
    minor_breaks = NULL
  ) +
  scale_colour_viridis_c(          # Use the cividis palette
    option = "C",                  # Qualitative set.
    alpha = 0.8,                   # Include some transparency
    guide = "none"
  ) +
  scale_size_continuous(           # Fine-tune the sizes of each point.
    guide = "none"                # Remove the legend for size.
  ) +
  theme_classic() +                  # Use a simpler theme.
  labs(                            # Make the titles nice.
    x = "Energy",
    y = "Danceability"
  )
ggplotly(all_plots)
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

                  
```

